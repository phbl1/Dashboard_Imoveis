<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas RE/MAX | Vers√£o Melhorada</title>
    <style>
        /* ESTILOS (incluindo novos estilos para notifica√ß√µes, bot√µes de ordena√ß√£o, etc.) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; }
        .header { background: linear-gradient(135deg, #310adb 0%, #c53030 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 8px 32px rgba(229, 62, 62, 0.3); position: relative; }
        .header h1 { font-size: 2.8rem; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .logo { display: flex; align-items: center; gap: 12px; }
        .balloon-container {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 150px;
    height: 200px;
    z-index: 1000;
    pointer-events: none;
}

.balloon {
    width: 100%;
    height: 100%;
    animation: float 8s infinite ease-in-out;
    transform-origin: center bottom;
    filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-15px) rotate(3deg); }
    50% { transform: translateY(0) rotate(0deg); }
    75% { transform: translateY(10px) rotate(-3deg); }
}
        .logo-icon { width: 70px; height: 70px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #c53030; font-weight: bold; font-size: 1.4rem; }
        .header-controls { display: flex; align-items: center; gap: 15px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .upload-button { background: rgba(255, 255, 255, 0.2); border: 2px solid white; color: white; padding: 12px 24px; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-size: 1rem; font-weight: 600; backdrop-filter: blur(10px); }
        .upload-button:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .upload-button.dragover { background: rgba(255, 255, 255, 0.4); transform: scale(1.05); }
        .upload-input { display: none; }
        .upload-icon { font-size: 1.2rem; }
        .clear-button { background: #e53e3e; color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: none; }
        .clear-button:hover { background: #c53030; transform: scale(1.05); }
        .file-info { background: rgba(255, 255, 255, 0.95); color: #2d3748; padding: 8px 16px; border-radius: 15px; margin-top: 10px; font-size: 0.9rem; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); display: none; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-bottom: 35px; }
        .summary-card { background: white; padding: 25px; border-radius: 18px; text-align: center; box-shadow: 0 5px 25px rgba(0,0,0,0.12); border-left: 6px solid #e53e3e; }
        .summary-card h3 { color: #555; margin-bottom: 12px; font-size: 1.0rem; text-transform: uppercase; letter-spacing: 1.2px; }
        .summary-card .value { font-size: 2.5rem; font-weight: bold; color: #222; }
        .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 35px; margin-bottom: 35px; }
        .chart-container { background: white; padding: 30px; border-radius: 22px; box-shadow: 0 10px 35px rgba(0,0,0,0.12); position: relative; }
        .chart-container h3 { color: #222; margin-bottom: 25px; font-size: 1.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px; }
        .chart-container canvas { max-height: 350px; }
        .regions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 10px; }
        .regions-title { font-size: 1.8rem; font-weight: bold; color: #333; }
        .sort-controls { display: flex; gap: 10px; }
        .sort-button { background: #edf2f7; border: 1px solid #e2e8f0; color: #4a5568; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        .sort-button.active { background: #e53e3e; color: white; border-color: #e53e3e; }
        .regions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 30px; }
        .region-card { background: white; border-radius: 22px; padding: 30px; box-shadow: 0 10px 35px rgba(0,0,0,0.12); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .region-card:hover { transform: translateY(-7px); box-shadow: 0 15px 45px rgba(0,0,0,0.18); }
        .region-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, #e53e3e, #c53030); }
        .performance-high::before { background: linear-gradient(90deg, #38a169, #2f855a); }
        .performance-medium::before { background: linear-gradient(90deg, #d69e2e, #b7791f); }
        .performance-low::before { background: linear-gradient(90deg, #e53e3e, #c53030); }
        .region-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .region-name { font-size: 1.8rem; font-weight: bold; color: #222; }
        .performance-badge { padding: 6px 14px; border-radius: 22px; font-size: 0.9rem; font-weight: bold; text-transform: uppercase; }
        .badge-high { background: #c6f6d5; color: #2f855a; }
        .badge-medium { background: #faf089; color: #b7791f; }
        .badge-low { background: #fed7d7; color: #c53030; }
        .metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .metric { text-align: center; padding: 18px; background: #f7fafc; border-radius: 12px; }
        .metric-label { font-size: 0.9rem; color: #555; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.8px; }
        .metric-value { font-size: 1.4rem; font-weight: bold; color: #222; }
        .brokers { border-top: 1px solid #e2e8f0; padding-top: 20px; }
        .brokers-title { font-size: 1.0rem; color: #555; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.8px; }
        .broker-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .broker-tag { background: #edf2f7; padding: 6px 12px; border-radius: 18px; font-size: 0.9rem; color: #4a5568; }
        .no-data { text-align: center; color: #888; font-style: italic; padding: 50px; }
        .loading { display: none; text-align: center; padding: 50px; color: #555; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #e53e3e; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 25px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification { position: fixed; top: 0; left: 0; right: 0; padding: 15px; color: white; text-align: center; font-weight: bold; z-index: 1000; transform: translateY(-100%); transition: transform 0.3s ease-in-out; }
        #notification.show { transform: translateY(0); }
        #notification.error { background-color: #c53030; }
        #notification.success { background-color: #2f855a; }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 20px; padding-bottom: 80px; }
            .header h1 { font-size: 2.2rem; }
            .header-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 100%; justify-content: center; }
            .regions-grid, .metrics, .charts-section { grid-template-columns: 1fr; }
            .regions-header { flex-direction: column; gap: 15px; } 
            .balloon-container {position: fixed;top: 20px;right: 20px;
    width: 150px;
    height: 200px;
    z-index: 1000;
    pointer-events: none;
}

.balloon {
    width: 100%;
    height: 100%;
    animation: float 8s infinite ease-in-out;
    transform-origin: center bottom;
    filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-15px) rotate(3deg); }
    50% { transform: translateY(0) rotate(0deg); }
    75% { transform: translateY(10px) rotate(-3deg); }
} 
        }
    </style>
</head>
<body>
    <div id="notification"></div>

    <div class="header">
        <h1>GEST√ÉO DE VENDAS</h1>
        <div class="header-controls">
            <div class="upload-button">
                <input type="file" id="fileInput" class="upload-input" accept=".xlsx,.xls" />
                <span class="upload-icon">üìä</span>
                <span id="upload-text">Carregar Excel</span>
            </div>
            <div class="clear-button" id="clearButton">Limpar</div>
        </div>
        <div class="logo">
            <div class="logo-icon"><div class="balloon-container">
    <div class="balloon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <!-- SVG do bal√£o aqui -->
              <rect width="6" height="1" x="21" y="44" fill="#757575"/>
                <polygon fill="#616161" points="25.5,47 22.5,47 22,45 26,45"/>
                <polygon fill="#424242" points="24,45 22,45 22.5,47 24,47"/>
                <g>
                    <path fill="#e8e8e8" d="M42,18c0,2.25-0.527,4.5-1.384,6.671L7.438,24.807C6.55,22.594,6,20.297,6,18 c0-2.098,0.28-3.969,0.799-5.625C6.799,12.375,9,5,24,5s17.191,7.343,17.191,7.343C41.717,14.007,42,15.889,42,18z"/>
                    <path fill="#b71c1c" d="M6.801,12.375C7.663,11.073,9.504,10,12,10l1.711-5.777C11.375,4.5,7.996,8.566,6.801,12.375z"/>
                    <path fill="#b71c1c" d="M41.199,12.375C40.337,11.073,38.496,10,36,10l-1.711-5.777C36.625,4.5,40.004,8.566,41.199,12.375z"/>
                    <path fill="#1a237e" d="M35.998,23C33.033,23,14.965,23,12,23c-1.946,0-3.617,0.774-4.559,1.806C11.195,34.153,21,42,21,42 h5.998c0,0,9.805-7.847,13.559-17.194C39.614,23.774,37.944,23,35.998,23z"/>
                    <path fill="#283593" d="M28.998,21c-4.142,0-5.856,0-9.998,0c-4,0-5.5,0.75-7,2c0,0,2,8,10,19h4c8-11,9.998-19,9.998-19 C34.498,21.75,32.998,21,28.998,21z"/>
                    <path fill="#303f9f" d="M24,20c-3,0-5,1-5,1c0,13.098,4,21,4,21h2c0,0,4-7.902,4-21C29,21,27,20,24,20z"/>
                    <path fill="#d32f2f" d="M34.289,4.223c-0.612-0.802-1.979-1.631-3.634-2.001C29.697,2.009,28.778,1.954,28,2.036 l-8.016-0.002c-0.775-0.08-1.688-0.024-2.639,0.188c-1.655,0.37-3.022,1.198-3.634,2.001C13.711,4.223,12,7.5,12,10 c0,0,1.875-1.875,5.125-1.875C18.5,8.125,19,8.375,19,8.375S19.75,5.5,24,5.5s5,2.875,5,2.875s0.5-0.25,1.875-0.25 C34.125,8.125,36,10,36,10C36,7.5,34.289,4.223,34.289,4.223z"/>
                    <path fill="#e53935" d="M24,7c2.086,0,3.925,0.567,5,1.375c0-4-1-6.339-1-6.339C27.125,1.375,25.754,1,24,1 s-3.125,0.375-4.016,1.035c0,0-0.984,2.34-0.984,6.34C20.075,7.568,21.915,7,24,7z"/>
                </g>
                <g>
                    <path fill="#283593" d="M14.43,18.13l-0.982-1.289c0.602-0.384,0.927-0.859,0.927-1.644c0-0.493-0.263-0.989-0.669-1.265 c-0.421-0.284-0.96-0.32-1.517-0.097L11.54,14.09c-0.34,0.14-0.67,0.28-0.98,0.43l0.28,4.87c0.3-0.14,0.63-0.28,0.97-0.41 l-0.075-1.361l0.701-0.28c0.036-0.015,0.067-0.029,0.103-0.044l0.872,1.135C13.75,18.32,14.08,18.23,14.43,18.13z M11.677,16.566 l-0.078-1.418l0.962-0.385c0.244-0.096,0.442-0.098,0.585-0.003c0.149,0.102,0.229,0.3,0.229,0.437 c0,0.453-0.059,0.713-1.311,1.214L11.677,16.566z"/>
                    <path fill="#d32f2f" d="M22.67,12.02l-2.58,5.16c-0.4,0.03-0.79,0.07-1.17,0.12l2.61-5.23h0.01 C21.91,12.05,22.28,12.03,22.67,12.02z"/>
                    <path fill="#283593" d="M26.19,12.06h-0.01L25,13.75l-1.214-1.727l-1.036,2.072v2.925c0.33-0.01,0.66-0.02,1-0.02v-3.29 L25,15.5l1.25-1.79v3.35c0.34,0.01,0.67,0.04,1,0.06v-5C26.9,12.09,26.55,12.07,26.19,12.06z"/>
                    <path fill="#283593" d="M16.68,12.64c-0.34,0.06-0.67,0.13-1,0.2l0.18,4.96c0.33-0.07,0.66-0.133,1-0.193l0,0 c0.283-0.051,0.571-0.098,0.86-0.142l0.541-1.084c-0.49,0.066-0.962,0.152-1.437,0.234L16.79,15.68 c0.648-0.114,1.309-0.215,1.985-0.298v-1.007c-0.688,0.083-1.361,0.184-2.022,0.297l-0.036-1.005 c0.74-0.138,1.503-0.255,2.283-0.351v-1.024c-0.789,0.095-1.469,0.203-2.318,0.349L16.68,12.64L16.68,12.64z"/>
                    <path fill="#283593" d="M36.27,16.36l1.4-1.73c-0.29-0.14-0.6-0.29-0.93-0.43l-0.91,1.13l-0.75-1.75 c-0.4-0.13-0.81-0.25-1.24-0.37l1.28,2.99l-1.56,1.93c0.36,0.1,0.7,0.2,1.04,0.3l0.97-1.2l0.77,1.81c0.48,0.19,0.92,0.39,1.34,0.6 L36.27,16.36z"/>
                    <path fill="#283593" d="M31.77,17.73c0.39,0.07,0.76,0.15,1.13,0.24l-1.663-5.345l-0.068-0.012 c-0.33-0.06-0.652-0.111-1.02-0.168l-0.01,0.026l-1.91,4.74c0.35,0.03,0.69,0.07,1.03,0.11l0.424-1.05 c0.593,0.102,1.173,0.217,1.74,0.344L31.77,17.73z M30.067,15.323l0.543-1.343l0.475,1.536 C30.75,15.448,30.411,15.384,30.067,15.323z"/>
                </g>
            </svg>
        </div>
    </div>
        </svg>
    </div>
</div></div>
            
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processando dados...</p>
    </div>

    <div class="no-data" id="noData">
        <div style="font-size: 4rem; margin-bottom: 20px;">üìà</div>
        <h3>Carregue uma planilha Excel para visualizar os dados</h3>
        <p>A planilha deve conter as colunas: <strong>Regi√£o, Corretor, VGV, Im√≥veis</strong></p>
    </div>

    <div id="dashboardContent" style="display: none;">
        <div class="summary-cards" id="summaryCards"></div>
        <div class="charts-section">
            <div class="chart-container">
                <h3>VGV por Regi√£o</h3>
                <canvas id="vgvChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Distribui√ß√£o de Im√≥veis</h3>
                <canvas id="imoveisChart"></canvas>
            </div>
            
        </div>
        <div class="regions-header">
            <h2 class="regions-title">Desempenho por Regi√£o</h2>
            <div class="sort-controls" id="sortControls">
                <button class="sort-button active" data-sort="vgv">Por VGV</button>
                <button class="sort-button" data-sort="imoveis">Por Im√≥veis</button>
                <button class="sort-button" data-sort="name">Por Nome (A-Z)</button>
            </div>
        </div>
        <div class="regions-grid" id="regionsGrid"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script>
    // **NOVO: C√ìDIGO ENCAPSULADO PARA MELHOR ORGANIZA√á√ÉO**
    const DashboardApp = {
        // --- PROPRIEDADES DO ESTADO DA APLICA√á√ÉO ---
        charts: { vgvChart: null, imoveisChart: null },
        data: { full: [], byRegion: {} },
        currentSort: 'vgv',

        // --- ELEMENTOS DA UI ---
        elements: {},

        // --- FUN√á√ÉO DE INICIALIZA√á√ÉO ---
        init() {
            this.cacheDOMElements();
            this.initEventListeners();
        },

        // --- ARMAZENA REFER√äNCIAS AOS ELEMENTOS DO DOM PARA PERFORMANCE ---
        cacheDOMElements() {
            this.elements = {
                fileInput: document.getElementById('fileInput'),
                uploadButton: document.querySelector('.upload-button'),
                uploadText: document.getElementById('upload-text'),
                clearButton: document.getElementById('clearButton'),
                loading: document.getElementById('loading'),
                dashboardContent: document.getElementById('dashboardContent'),
                noData: document.getElementById('noData'),
                summaryCards: document.getElementById('summaryCards'),
                regionsGrid: document.getElementById('regionsGrid'),
                vgvChartCanvas: document.getElementById('vgvChart'),
                imoveisChartCanvas: document.getElementById('imoveisChart'),
                notification: document.getElementById('notification'),
                sortControls: document.getElementById('sortControls'),
            };
        },

        // --- CONFIGURA TODOS OS EVENT LISTENERS ---
        initEventListeners() {
            const { fileInput, uploadButton, clearButton, sortControls } = this.elements;

            uploadButton.addEventListener('click', () => fileInput.click());
            uploadButton.addEventListener('dragover', (e) => { e.preventDefault(); uploadButton.classList.add('dragover'); });
            uploadButton.addEventListener('dragleave', () => uploadButton.classList.remove('dragover'));
            uploadButton.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadButton.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) this.handleFile(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) this.handleFile(e.target.files[0]);
            });
            clearButton.addEventListener('click', () => this.resetDashboard());

            sortControls.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    this.currentSort = e.target.dataset.sort;
                    this.updateSortButtons();
                    this.generateRegionCards();
                }
            });
        },

        // --- PROCESSAMENTO DO ARQUIVO EXCEL ---
        handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                this.showNotification('Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'error');
                return;
            }

            this.setLoadingState(true);
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    this.processExcelData(jsonData);
                } catch (error) {
                    this.handleError('Erro ao ler o arquivo: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        },

        // **NOVO: NORMALIZA√á√ÉO DOS CABE√áALHOS PARA MAIOR ROBUSTEZ**
        normalizeHeaders(data) {
            const normalize = str => str.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            const keyMap = {
                regiao: ['regiao', 'regioes', 'regi√£o'],
                corretor: ['corretor', 'corretora', 'corretores'],
                vgv: ['vgv'],
                imoveis: ['imoveis', 'imovel', 'im√≥veis', 'im√≥vel']
            };

            return data.map(row => {
                const newRow = {};
                for (const rawKey in row) {
                    const normalizedKey = normalize(rawKey);
                    for (const targetKey in keyMap) {
                        if (keyMap[targetKey].includes(normalizedKey)) {
                            newRow[targetKey] = row[rawKey];
                            break;
                        }
                    }
                }
                return newRow;
            });
        },
        
        processExcelData(jsonData) {
            try {
                const normalizedData = this.normalizeHeaders(jsonData);
                
                this.data.full = normalizedData.map(row => ({
                    regiao: row.regiao || '',
                    corretor: row.corretor || '',
                    vgv: parseFloat(row.vgv || 0),
                    imoveis: parseInt(row.imoveis || 0)
                })).filter(item => 
                    item.regiao && item.corretor && !isNaN(item.vgv) && !isNaN(item.imoveis)
                );

                if (this.data.full.length === 0) {
                    throw new Error('Nenhum dado v√°lido encontrado. Verifique se a planilha cont√©m as colunas: Regi√£o, Corretor, VGV, Im√≥veis.');
                }

                this.aggregateDataByRegion();
                this.renderDashboard();
                this.setLoadingState(false);
                this.showNotification('Dashboard atualizado com sucesso!', 'success');
            } catch (error) {
                this.handleError('Erro ao processar os dados: ' + error.message);
            }
        },

        aggregateDataByRegion() {
            this.data.byRegion = {};
            this.data.full.forEach(item => {
                if (!this.data.byRegion[item.regiao]) {
                    this.data.byRegion[item.regiao] = { corretores: new Set(), vgv: 0, imoveis: 0 };
                }
                this.data.byRegion[item.regiao].corretores.add(item.corretor);
                this.data.byRegion[item.regiao].vgv += item.vgv;
                this.data.byRegion[item.regiao].imoveis += item.imoveis;
            });
        },
        
        // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
        renderDashboard() {
            this.elements.dashboardContent.style.display = 'block';
            this.elements.clearButton.style.display = 'inline-block';
            this.elements.uploadText.textContent = 'Carregar Outro';
            this.generateSummaryCards();
            this.generateCharts();
            this.updateSortButtons();
            this.generateRegionCards();
        },

        generateSummaryCards() {
            const totalVGV = Object.values(this.data.byRegion).reduce((sum, r) => sum + r.vgv, 0);
            const totalImoveis = Object.values(this.data.byRegion).reduce((sum, r) => sum + r.imoveis, 0);
            const totalCorretores = new Set(this.data.full.map(item => item.corretor));
            const totalRegioes = Object.keys(this.data.byRegion).length;
            const mediaVGVPorCorretor = totalVGV / totalCorretores.size;
            const mediaImoveisPorCorretor = totalImoveis / totalCorretores.size;
            
            this.elements.summaryCards.innerHTML = `
                <div class="summary-card"><h3>VGV Total</h3><div class="value">R$ ${this.formatCurrency(totalVGV)}</div></div>
                <div class="summary-card"><h3>Im√≥veis Ativos</h3><div class="value">${totalImoveis.toLocaleString('pt-BR')}</div></div>
                <div class="summary-card"><h3>Corretores</h3><div class="value">${totalCorretores.size}</div></div>
                <div class="summary-card"><h3>Regi√µes</h3><div class="value">${totalRegioes}</div></div>
                 <div class="summary-card"><h3>M√©dia VGV/Corretor</h3><div class="value">R$ ${this.formatCurrency(mediaVGVPorCorretor)}</div>
    </div>
                `;
        },

        // **NOVO: L√ìGICA DE ORDENA√á√ÉO**
        generateRegionCards() {
            const regionsGrid = this.elements.regionsGrid;
            regionsGrid.innerHTML = '';

            const sortedRegions = Object.entries(this.data.byRegion).sort(([, a], [, b]) => {
                switch (this.currentSort) {
                    case 'imoveis': return b.imoveis - a.imoveis;
                    case 'name': return a.corretores.values().next().value.localeCompare(b.corretores.values().next().value); // Just kidding, sorting by region name
                    case 'vgv':
                    default: return b.vgv - a.vgv;
                }
            });
            
            // Correction for sorting by name (A-Z)
            if (this.currentSort === 'name') {
                 sortedRegions.sort(([nameA], [nameB]) => nameA.localeCompare(nameB));
            }


            sortedRegions.forEach(([regiao, data]) => {
                const { performanceClass, performanceLabel } = this.getPerformanceInfo(data.vgv);
                const regionCard = document.createElement('div');
                regionCard.className = `region-card ${performanceClass}`;
                regionCard.innerHTML = `
                    <div class="region-header">
                        <div class="region-name">${regiao}</div>
                        <div class="performance-badge ${performanceClass.replace('performance-', 'badge-')}">${performanceLabel}</div>
                    </div>
                    <div class="metrics">
                        <div class="metric"><div class="metric-label">VGV</div><div class="metric-value">R$ ${this.formatCurrency(data.vgv)}</div></div>
                        <div class="metric"><div class="metric-label">Im√≥veis</div><div class="metric-value">${data.imoveis.toLocaleString('pt-BR')}</div></div>
                    </div>
                    <div class="brokers">
                        <div class="brokers-title">Corretores (${data.corretores.size})</div>
                        <div class="broker-list">${Array.from(data.corretores).map(c => `<div class="broker-tag">${c}</div>`).join('')}</div>
                    </div>
                `;
                regionsGrid.appendChild(regionCard);
            });
        },

        generateCharts() {
            if (this.charts.vgvChart) this.charts.vgvChart.destroy();
            if (this.charts.imoveisChart) this.charts.imoveisChart.destroy();

            const regions = Object.keys(this.data.byRegion);
            const vgvValues = regions.map(r => this.data.byRegion[r].vgv / 1000000);
            const imoveisValues = regions.map(r => this.data.byRegion[r].imoveis);

            this.charts.vgvChart = new Chart(this.elements.vgvChartCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: regions,
                    datasets: [{
                        label: 'VGV (Milh√µes R$)',
                        data: vgvValues,
                        backgroundColor: regions.map(r => this.getPerformanceInfo(this.data.byRegion[r].vgv).color),
                        borderColor: regions.map(r => this.getPerformanceInfo(this.data.byRegion[r].vgv).borderColor),
                        borderWidth: 2, borderRadius: 8, borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `VGV: R$ ${c.parsed.y.toFixed(1)}M` } } },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => `R$ ${v.toFixed(1)}M` } } }
                }
            });

            this.charts.imoveisChart = new Chart(this.elements.imoveisChartCanvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: regions,
                    datasets: [{
                        label: 'Im√≥veis', data: imoveisValues,
                        backgroundColor: ['#e53e3e', '#38a169', '#d69e2e', '#3182ce', '#805ad5', '#dd6b20', '#319795'],
                        borderWidth: 2, borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
                        tooltip: { callbacks: {
                            label: c => {
                                const total = c.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((c.parsed / total) * 100).toFixed(1);
                                return `${c.label}: ${c.parsed} im√≥veis (${percentage}%)`;
                            }
                        }}
                    }
                }
            });
        },
        
        // --- FUN√á√ïES DE ESTADO DA UI E UTILIT√ÅRIOS ---
        setLoadingState(isLoading) {
            this.elements.loading.style.display = isLoading ? 'block' : 'none';
            this.elements.noData.style.display = 'none';
            this.elements.dashboardContent.style.display = isLoading ? 'none' : this.elements.dashboardContent.style.display;
        },

        // **NOVO: RESET DO DASHBOARD**
        resetDashboard() {
            if (this.charts.vgvChart) this.charts.vgvChart.destroy();
            if (this.charts.imoveisChart) this.charts.imoveisChart.destroy();
            this.data = { full: [], byRegion: {} };
            this.elements.dashboardContent.style.display = 'none';
            this.elements.noData.style.display = 'block';
            this.elements.clearButton.style.display = 'none';
            this.elements.uploadText.textContent = 'Carregar Excel';
            this.elements.fileInput.value = ''; // Permite recarregar o mesmo arquivo
            this.showNotification('Dashboard limpo.', 'success');
        },

        // **NOVO: SISTEMA DE NOTIFICA√á√ÉO**
        showNotification(message, type = 'error') {
            const { notification } = this.elements;
            notification.textContent = message;
            notification.className = type;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        },

        handleError(errorMessage) {
            console.error(errorMessage);
            this.showNotification(errorMessage, 'error');
            this.setLoadingState(false);
            this.elements.noData.style.display = 'block';
        },

        updateSortButtons() {
            this.elements.sortControls.querySelectorAll('.sort-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sort === this.currentSort);
            });
        },

        // --- FUN√á√ïES AUXILIARES DE C√ÅLCULO E FORMATA√á√ÉO ---
        getPerformanceInfo(vgv) {
            const vgvValues = Object.values(this.data.byRegion).map(r => r.vgv);
            const maxVgv = Math.max(...vgvValues);
            const minVgv = Math.min(...vgvValues);
            const range = maxVgv - minVgv;
            
            if (range === 0 || vgv >= minVgv + (range * 0.66)) {
                return { performanceClass: 'performance-high', performanceLabel: 'Alto', color: 'rgba(56, 161, 105, 0.8)', borderColor: '#2f855a' };
            } else if (vgv >= minVgv + (range * 0.33)) {
                return { performanceClass: 'performance-medium', performanceLabel: 'M√©dio', color: 'rgba(214, 158, 46, 0.8)', borderColor: '#b7791f' };
            } else {
                return { performanceClass: 'performance-low', performanceLabel: 'Baixo', color: 'rgba(229, 62, 62, 0.8)', borderColor: '#c53030' };
            }
        },

        formatCurrency(value) {
            if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
            if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
            return value.toLocaleString('pt-BR');
        }
    };

    // --- INICIA A APLICA√á√ÉO QUANDO O DOM ESTIVER PRONTO ---
    document.addEventListener('DOMContentLoaded', () => DashboardApp.init());
    </script>
</body>
</html>